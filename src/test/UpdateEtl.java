package test;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import org.junit.Test;

public class UpdateEtl {
	
	public String orgaId [] = {"PRO_001","PRO_001_001","PRO_001_001_001","PRO_001_001_002",
			"PRO_001_001_003","PRO_001_001_004","PRO_001_001_005","PRO_001_001_006",
			"PRO_001_001_007","PRO_001_001_008","PRO_001_001_009","PRO_001_002",
			"PRO_001_002_001","PRO_001_002_002","PRO_001_002_003","PRO_001_003",
			"PRO_001_003_001","PRO_001_003_002","PRO_001_003_003","PRO_001_003_004",
			"PRO_001_003_005","PRO_001_003_006","PRO_001_003_007","PRO_001_004",
			"PRO_001_004_001","PRO_001_004_002","PRO_001_004_003","PRO_001_004_004",
			"PRO_001_004_005","PRO_001_005","PRO_001_005_001","PRO_001_005_002",
			"PRO_001_005_003","PRO_001_005_004","PRO_001_005_005","PRO_001_005_006",
			"PRO_001_005_007","PRO_001_006","PRO_001_006_001","PRO_001_006_002",
			"PRO_001_006_003","PRO_001_006_004","PRO_001_006_005","PRO_001_006_006",
			"PRO_001_006_007","PRO_001_006_008","PRO_001_006_009","PRO_001_006_010",
			"PRO_001_007","PRO_001_007_001","PRO_001_007_002","PRO_001_007_003",
			"PRO_001_007_004","PRO_001_007_005","PRO_001_007_006","PRO_001_008",
			"PRO_001_008_001","PRO_001_008_002","PRO_001_008_003","PRO_001_008_004",
			"PRO_001_008_005","PRO_001_008_006","PRO_001_008_007","PRO_001_008_008",
			"PRO_001_008_009","PRO_001_009","PRO_001_009_001","PRO_001_009_002",
			"PRO_001_009_003","PRO_001_009_004","PRO_001_009_005","PRO_001_009_006",
			"PRO_001_009_007","PRO_001_010","PRO_001_010_001","PRO_001_010_002",
			"PRO_001_010_003","PRO_001_010_004","PRO_001_010_005","PRO_001_010_006",
			"PRO_001_010_007","PRO_001_010_008","PRO_001_011","PRO_001_011_001",
			"PRO_001_011_002","PRO_001_011_003","PRO_001_011_004","PRO_001_012",
			"PRO_001_012_001","PRO_001_012_002","PRO_001_012_003","PRO_001_012_004",
			"PRO_001_012_005","PRO_001_012_006","PRO_001_013","PRO_001_013_001",
			"PRO_001_013_002","PRO_001_013_003","PRO_001_013_004","PRO_001_013_005",
			"PRO_001_014","PRO_001_014_001","PRO_001_014_002","PRO_001_014_003",
			"PRO_001_014_004","PRO_001_014_005","PRO_001_014_006","PRO_001_014_007",
			"PRO_001_014_008","PRO_001_015","PRO_001_015_001","PRO_001_015_002",
			"PRO_001_015_003","PRO_001_015_004","PRO_001_015_005","PRO_001_015_006",
			"PRO_001_015_007","PRO_001_015_008","PRO_001_015_009","PRO_001_015_010",
			"PRO_001_015_011","PRO_001_015_012","PRO_001_015_013","PRO_001_015_014",
			"PRO_001_015_015","PRO_001_015_016","PRO_001_015_017","PRO_001_015_018",
			"PRO_001_015_019","PRO_001_015_020","PRO_001_015_021","PRO_001_015_022",
			"PRO_001_015_023","PRO_001_015_024","PRO_001_015_025","PRO_001_015_026",
			"PRO_001_015_027","PRO_001_015_028","PRO_001_015_029","PRO_001_015_030",
			"PRO_001_016","PRO_001_016_001","PRO_001_016_002","PRO_001_016_003",
			"PRO_001_016_004","PRO_001_016_005","PRO_001_016_006","PRO_001_016_007",
			"PRO_001_016_008","PRO_001_016_009","PRO_001_016_010","PRO_001_016_011",
			"PRO_001_016_012","PRO_001_016_013","PRO_001_016_014","PRO_001_016_015",
			"PRO_001_016_016","PRO_001_016_017","PRO_001_016_018","PRO_001_016_019",
			"PRO_001_016_020","PRO_001_016_021","PRO_001_016_022","PRO_001_016_023",
			"PRO_001_016_024","PRO_001_017","PRO_001_017_001","PRO_001_017_002",
			"PRO_001_017_003","PRO_001_018","PRO_001_018_001","PRO_001_018_002",
			"PRO_001_018_003","PRO_001_018_004","PRO_001_018_005","PRO_001_018_006",
			"PRO_001_019","PRO_001_019_001","PRO_001_019_002","PRO_001_019_003",
			"PRO_001_019_004","PRO_001_019_005","PRO_002","PRO_002_001","PRO_002_001_001",
			"PRO_002_001_002","PRO_002_001_003","PRO_002_001_004","PRO_002_001_005",
			"PRO_002_001_006","PRO_002_002","PRO_002_002_001","PRO_002_002_002",
			"PRO_002_002_003","PRO_002_002_004","PRO_002_003","PRO_002_003_001",
			"PRO_002_003_002","PRO_002_003_003","PRO_002_003_004","PRO_002_003_005",
			"PRO_002_004","PRO_002_004_001","PRO_002_004_002","PRO_002_005",
			"PRO_002_005_001","PRO_002_005_002","PRO_002_005_003","PRO_002_005_004",
			"PRO_002_005_005","PRO_002_005_006","PRO_002_006","PRO_002_006_001",
			"PRO_002_006_002","PRO_002_006_003","PRO_002_007","PRO_002_007_001",
			"PRO_002_007_002","PRO_002_008","PRO_002_008_001","PRO_002_009",
			"PRO_002_009_001","PRO_002_010","PRO_002_010_001","PRO_002_010_002",
			"PRO_002_011","PRO_002_011_001","PRO_002_011_002","PRO_002_012",
			"PRO_002_012_001","PRO_002_012_002","PRO_002_012_003","PRO_002_012_004",
			"PRO_002_012_005","PRO_002_013","PRO_002_013_001","PRO_002_013_002",
			"PRO_002_013_003","PRO_002_013_004","PRO_002_014","PRO_003","PRO_003_001",
			"PRO_003_001_001","PRO_003_001_002","PRO_003_001_003","PRO_003_001_004",
			"PRO_003_001_005","PRO_003_001_006","PRO_003_001_007","PRO_003_001_008",
			"PRO_003_002","PRO_003_002_001","PRO_003_002_002","PRO_003_002_003",
			"PRO_003_002_004","PRO_003_002_005","PRO_003_002_006","PRO_003_002_007",
			"PRO_003_002_008","PRO_003_002_009","PRO_003_003","PRO_003_003_001",
			"PRO_003_003_002","PRO_003_003_003","PRO_003_003_004","PRO_003_003_005",
			"PRO_003_003_006","PRO_003_003_007","PRO_003_003_008","PRO_003_003_009",
			"PRO_003_003_010","PRO_003_004","PRO_003_004_001","PRO_003_004_002",
			"PRO_003_004_003","PRO_003_004_004","PRO_003_004_005","PRO_003_004_006",
			"PRO_003_004_007","PRO_003_004_008","PRO_003_005","PRO_003_005_001",
			"PRO_003_005_002","PRO_003_005_003","PRO_003_005_004","PRO_003_005_005",
			"PRO_003_005_006","PRO_003_005_007","PRO_003_005_008","PRO_003_005_009",
			"PRO_003_005_010","PRO_003_005_011","PRO_003_005_012","PRO_003_006",
			"PRO_003_006_001","PRO_003_006_002","PRO_003_006_003","PRO_003_006_004",
			"PRO_003_006_005","PRO_003_006_006","PRO_003_006_007","PRO_003_006_008",
			"PRO_003_006_009","PRO_003_006_010","PRO_003_007","PRO_003_007_001",
			"PRO_003_007_002","PRO_003_007_003","PRO_003_007_004","PRO_003_007_005",
			"PRO_003_007_006","PRO_003_007_007","PRO_003_007_008","PRO_003_007_009",
			"PRO_003_007_010","PRO_003_008","PRO_003_008_001","PRO_003_008_002",
			"PRO_003_008_003","PRO_003_008_004","PRO_003_008_005","PRO_003_008_006",
			"PRO_003_008_007","PRO_003_008_008","PRO_003_008_009","PRO_003_008_010",
			"PRO_003_009","PRO_003_009_001","PRO_003_009_002","PRO_003_009_003",
			"PRO_003_010","PRO_003_010_001","PRO_003_010_002","PRO_003_010_003",
			"PRO_003_010_004","PRO_003_010_005","PRO_003_010_006","PRO_003_010_007",
			"PRO_003_010_008","PRO_003_011","PRO_003_011_001","PRO_003_011_002",
			"PRO_003_012","PRO_003_013","PRO_003_013_001","PRO_003_013_002",
			"PRO_003_013_003","PRO_003_013_004","PRO_003_014","PRO_003_014_001",
			"PRO_003_014_002","PRO_003_014_003","PRO_003_014_004","PRO_003_014_005",
			"PRO_003_015","PRO_003_016","PRO_003_016_001","PRO_003_016_002",
			"PRO_003_016_003","PRO_003_016_004","PRO_003_017","PRO_004","PRO_004_001",
			"PRO_004_001_001","PRO_004_001_002","PRO_004_001_003","PRO_004_001_004",
			"PRO_004_001_005","PRO_004_001_006","PRO_004_001_007","PRO_004_001_008",
			"PRO_004_001_009","PRO_004_002","PRO_004_002_001","PRO_004_002_002",
			"PRO_004_002_003","PRO_004_002_004","PRO_004_003","PRO_004_003_001",
			"PRO_004_003_002","PRO_004_003_003","PRO_004_003_004","PRO_004_003_005",
			"PRO_004_003_006","PRO_004_003_007","PRO_004_003_008","PRO_004_003_009",
			"PRO_004_003_010","PRO_004_003_011","PRO_004_003_012","PRO_004_003_013",
			"PRO_004_003_014","PRO_004_004","PRO_004_004_001","PRO_004_004_002",
			"PRO_004_004_003","PRO_004_004_004","PRO_004_004_005","PRO_004_004_006",
			"PRO_004_005","PRO_004_005_001","PRO_004_005_002","PRO_004_005_003",
			"PRO_004_005_004","PRO_004_005_005","PRO_004_005_006","PRO_004_005_007",
			"PRO_004_005_008","PRO_004_005_009","PRO_004_005_010","PRO_004_006",
			"PRO_004_006_001","PRO_004_006_002","PRO_004_006_003","PRO_004_006_004",
			"PRO_004_006_005","PRO_004_006_006","PRO_004_006_007","PRO_004_007",
			"PRO_004_007_001","PRO_004_007_002","PRO_004_007_003","PRO_004_007_004",
			"PRO_004_007_005","PRO_004_007_006","PRO_004_007_007","PRO_004_007_008",
			"PRO_004_008","PRO_004_008_001","PRO_004_008_002","PRO_004_008_003",
			"PRO_004_008_004","PRO_004_008_005","PRO_004_008_006","PRO_004_008_007",
			"PRO_004_008_008","PRO_004_008_009","PRO_004_008_010","PRO_004_008_011",
			"PRO_004_008_012","PRO_004_008_013","PRO_004_008_014","PRO_004_008_015",
			"PRO_004_008_016","PRO_004_009","PRO_004_009_001","PRO_004_009_002",
			"PRO_004_009_003","PRO_004_009_004","PRO_004_009_005","PRO_004_009_006",
			"PRO_004_009_007","PRO_004_009_008","PRO_004_009_009","PRO_004_009_010",
			"PRO_004_009_011","PRO_004_010","PRO_005","PRO_005_001","PRO_005_001_001",
			"PRO_005_001_002","PRO_005_001_003","PRO_005_001_004","PRO_005_001_005",
			"PRO_005_001_006","PRO_005_001_007","PRO_005_001_008","PRO_005_001_009",
			"PRO_005_001_010","PRO_005_001_011","PRO_005_001_012","PRO_005_001_013",
			"PRO_005_001_014","PRO_005_001_015","PRO_005_001_016","PRO_005_001_017",
			"PRO_005_001_018","PRO_005_002","PRO_005_002_001","PRO_005_002_002",
			"PRO_005_002_003","PRO_005_002_004","PRO_005_002_005","PRO_005_002_006",
			"PRO_005_002_007","PRO_005_002_008","PRO_005_003","PRO_005_003_001",
			"PRO_005_003_002","PRO_005_003_003","PRO_005_003_004","PRO_005_003_005",
			"PRO_005_003_006","PRO_005_003_007","PRO_005_003_008","PRO_005_003_009",
			"PRO_005_003_010","PRO_005_003_011","PRO_005_003_012","PRO_005_003_013",
			"PRO_005_004","PRO_005_004_001","PRO_005_004_002","PRO_005_004_003",
			"PRO_005_004_004","PRO_005_004_005","PRO_005_004_006","PRO_005_004_007",
			"PRO_005_004_008","PRO_005_005","PRO_005_005_001","PRO_005_005_002",
			"PRO_005_005_003","PRO_005_005_004","PRO_005_005_005","PRO_005_005_006",
			"PRO_005_005_007","PRO_005_005_008","PRO_005_005_009","PRO_005_005_010",
			"PRO_005_005_011","PRO_005_005_012","PRO_005_006","PRO_005_006_001",
			"PRO_005_006_002","PRO_005_006_003","PRO_005_006_004","PRO_005_006_005",
			"PRO_005_006_006","PRO_005_006_007","PRO_005_006_008","PRO_005_006_009",
			"PRO_005_007","PRO_005_007_001","PRO_005_007_002","PRO_005_007_003",
			"PRO_005_007_004","PRO_005_007_005","PRO_005_007_006","PRO_005_007_007",
			"PRO_005_007_008","PRO_005_007_009","PRO_005_007_010","PRO_005_008",
			"PRO_005_008_001","PRO_005_008_002","PRO_005_008_003","PRO_005_008_004",
			"PRO_005_009","PRO_005_009_001","PRO_005_009_002","PRO_005_009_003",
			"PRO_005_009_004","PRO_005_009_005","PRO_005_009_006","PRO_005_010",
			"PRO_005_010_001","PRO_005_010_002","PRO_005_010_003","PRO_005_010_004",
			"PRO_005_010_005","PRO_005_010_006","PRO_005_011","PRO_005_011_001",
			"PRO_005_011_002","PRO_005_011_003","PRO_005_011_004","PRO_005_011_005",
			"PRO_005_011_006","PRO_005_011_007","PRO_005_012","PRO_005_012_001",
			"PRO_005_012_002","PRO_005_012_003","PRO_005_012_004","PRO_005_012_005",
			"PRO_005_012_006","PRO_005_013","PRO_005_013_001","PRO_005_013_002",
			"PRO_005_013_003","PRO_005_013_004","PRO_005_013_005","PRO_005_013_006",
			"PRO_005_013_007","PRO_005_014","PRO_005_014_001","PRO_005_014_002",
			"PRO_005_014_003","PRO_005_014_004","PRO_005_015","PRO_005_015_001",
			"PRO_005_015_002","PRO_005_015_003","PRO_005_015_004","PRO_005_015_005",
			"PRO_005_016","PRO_005_016_001","PRO_005_016_002","PRO_005_016_003",
			"PRO_005_016_004","PRO_005_016_005","PRO_005_016_006","PRO_005_016_007",
			"PRO_005_017","PRO_005_017_001","PRO_005_017_002","PRO_005_017_003",
			"PRO_005_017_004","PRO_005_017_005","PRO_005_017_006","PRO_005_017_007",
			"PRO_005_018","PRO_005_018_001","PRO_005_018_002","PRO_005_018_003",
			"PRO_005_018_004","PRO_005_018_005","PRO_005_019","PRO_005_019_001",
			"PRO_006","PRO_006_001","PRO_006_001_001","PRO_006_001_002",
			"PRO_006_001_003","PRO_006_001_004","PRO_006_001_005","PRO_006_001_006",
			"PRO_006_001_007","PRO_006_002","PRO_006_002_001","PRO_006_002_002",
			"PRO_006_002_003","PRO_006_002_004","PRO_006_002_005","PRO_006_002_006",
			"PRO_006_003","PRO_006_003_001","PRO_006_003_002","PRO_006_003_003",
			"PRO_006_003_004","PRO_006_003_005","PRO_006_003_006","PRO_006_003_007",
			"PRO_006_004","PRO_006_004_001","PRO_006_005","PRO_006_005_001",
			"PRO_006_005_002","PRO_006_005_003","PRO_006_005_004","PRO_006_005_005",
			"PRO_006_005_006","PRO_006_005_007","PRO_006_005_008","PRO_006_006",
			"PRO_006_006_001","PRO_006_006_002","PRO_006_007","PRO_006_007_001",
			"PRO_006_008","PRO_006_008_001","PRO_006_009","PRO_006_009_001",
			"PRO_006_010","PRO_006_010_001","PRO_006_010_002","PRO_006_010_003",
			"PRO_006_010_004","PRO_006_010_005","PRO_006_010_006","PRO_006_010_007",
			"PRO_006_010_008","PRO_006_010_009","PRO_006_010_010","PRO_006_011",
			"PRO_006_011_001","PRO_006_011_002","PRO_006_011_003","PRO_006_011_004",
			"PRO_006_011_005","PRO_007","PRO_007_001","PRO_007_001_001","PRO_007_002",
			"PRO_007_002_001","PRO_007_003","PRO_007_003_001","PRO_007_004",
			"PRO_007_004_001","PRO_007_005","PRO_007_005_001","PRO_007_005_002",
			"PRO_007_005_003","PRO_007_005_004","PRO_007_005_005","PRO_007_006",
			"PRO_007_006_001","PRO_007_006_002","PRO_007_006_003","PRO_007_006_004",
			"PRO_007_006_005","PRO_007_006_006","PRO_007_006_007","PRO_007_007",
			"PRO_007_007_001","PRO_007_008","PRO_007_008_001","PRO_007_009",
			"PRO_007_009_001","PRO_007_010","PRO_007_010_001","SUB_001","SUB_002",
			"SUB_003","SUB_004","SUB_005","SUB_006","SUB_007","SUB_008","SUB_009",
			"SUB_010","SUB_011","SUB_012","SUB_013","NET_001"};
	
	public static void main(String[] args) {
		
	}
	
	@Test
	public void run () throws Exception {
		
		Date date = new Date();
		
		SimpleDateFormat sd = new SimpleDateFormat("YYYY-MM");
		
		DAO sqlLib = new DAO();
		
		ResultSet lib = sqlLib.resulet().executeQuery("select id,quota_name,table_name from oc_quota_lib order by id");
		
		while (lib.next()){
			
			DAO sqlIndex = new DAO();
			DAO sqlEtl = new DAO();
			DAO sqlExecute = new DAO();
			
			
			String etlDate = null;
			
			ResultSet index = sqlIndex.resulet().executeQuery("select etl_time from "+lib.getString(3)+" limit 1");
			if (index.next()) {
				etlDate = index.getString(1);
			}
		
			ResultSet etl = sqlEtl.resulet().executeQuery("select quota_id,quota_name,etl_update_date from oc_refresh_etl where quota_id = '"+lib.getString(1)+"'");
			
			if (etl.next()){
				 if (etlDate != null && (etl.getString(3) != null || etl.getString(3) != "" )) {
					 
					 if (etl.getString(3) != etlDate) {
						 
						 for (int i = 0 ; i < orgaId.length ; i ++) {
							 
							 sqlExecute.resulet().execute("select extract_quota_status_comm('"+lib.getString(1)+"','"+orgaId[i]+"','"+sd.format(date)+"')");
							 
						 }
						 
						 sqlExecute.resulet().execute("update oc_refresh_etl set etl_update_date = '"+etlDate+"' where quota_id = '"+lib.getString(1)+"'");
					 }
					 
				 }
			}else {
				try {
					
					sqlExecute.resulet().executeQuery("insert into oc_refresh_etl values('"+lib.getString(1)+"','"+lib.getString(2)+"','"+lib.getString(3)+"')");
				
				} catch (Exception e) {
					// TODO: handle exception
				}
			}
			
			
			
			
			
			sqlIndex.stopClose();
			sqlEtl.stopClose();
			sqlExecute.stopClose();
			sqlIndex = null;
			sqlEtl = null;
			sqlExecute = null;
		}
		
		sqlLib.stopClose();
		sqlLib = null;
	}
	
	@Test
	public void orga_id () throws Exception {
		
		DAO dao = new DAO();
		ResultSet list = dao.resulet().executeQuery("select id from oc_orga_dimension where orga_name != '全国' ");
		
		while (list.next()){
			System.out.print("\""+list.getString(1)+"\",");
		}
		
	}
	
	@Test
	public void next  () throws Exception  {
		
		DAO dao = new DAO();
		ResultSet list = dao.resulet().executeQuery("select * from oc_refresh_etl where quota_id = '2' ");
		System.out.println(list.next());
		
	}
	
	@Test
	public void date () {
		
		Date date = new Date();
		
		SimpleDateFormat sd = new SimpleDateFormat("YYYY-MM");
		
		System.out.println(sd.format(date));
		
	}
	
	@Test 
	public void etlTime () throws Exception {
		
		DAO sqlLib = new DAO();
		DAO sqlIndex = new DAO();
		ResultSet lib = sqlLib.resulet().executeQuery("select id,quota_name,table_name from oc_quota_lib order by id");
		
		while (lib.next()) {
			
			try {
				
				sqlLib.resulet().execute("ALTER table "+lib.getString(3)+" add etl_time varchar(50)");
				 
			} catch (Exception e) {
				System.out.println(lib.getString(1));
			}
			
		}
		
	}
	
	
}
